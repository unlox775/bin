#!/usr/bin/env python3

import boto3
import sys
import os
import argparse

def list_codebuild_projects(region, profile):
    session = boto3.Session(profile_name=profile, region_name=region)
    codebuild_client = session.client('codebuild')

    # Get all the CodeBuild projects
    projects = codebuild_client.list_projects()['projects']

    for project in projects:
        project_details = codebuild_client.batch_get_projects(names=[project])['projects'][0]
        print(f"Project: {project}")

        # Check if the source type is GITHUB
        if project_details['source']['type'] == 'GITHUB':
            source = project_details['source']
            print(f"Repository: {source['location']}")

            if 'buildspec' in source:
                print(f"Build Spec File: {source['buildspec']}")

            # Fetch Webhook details if available
            if 'webhook' in project_details:
                webhook = project_details['webhook']
                print(f"Webhook URL: {webhook['url']}")
                
                if 'filterGroups' in webhook:
                    for group in webhook['filterGroups']:
                        for filter in group:
                            print(f"Filter Type: {filter['type']}")
                            print(f"Filter Pattern: {filter['pattern']}")
                            if 'excludeMatchedPattern' in filter:
                                if filter['excludeMatchedPattern']:
                                    print("This pattern is excluded.")
                                else:
                                    print("This pattern is included.")
                
                if 'eventTypes' in webhook:
                    for event in webhook['eventTypes']:
                        print(f"Webhook event type: {event}")
        print("---------------------------")

    print("Done listing projects.")

def main():
    parser = argparse.ArgumentParser(
        description='''AWS CodeBuild project inventory and analysis tool.

This tool lists all CodeBuild projects in a specified region, providing detailed information 
about project configurations, source repositories, build specifications, and webhook settings. 
It's designed for CI/CD pipeline management and build system documentation.

Key use cases:
- Build pipeline inventory: List all CodeBuild projects in an account
- CI/CD audit: Document build configurations and triggers
- Repository mapping: Identify which repositories are connected to builds
- Webhook analysis: Understand build triggers and event patterns
- Build system documentation: Document build specifications and configurations

The tool provides comprehensive details about each CodeBuild project including source 
repository information, build specification files, webhook configurations, and event 
filters. It's particularly useful for understanding GitHub integration and build triggers.''',
        formatter_class=argparse.RawDescriptionHelpFormatter
    )
    parser.add_argument('region', help='AWS region (default: us-east-1)', nargs='?', default='us-east-1')
    parser.add_argument('profile', help='AWS profile name (default: default)', nargs='?', default='default')
    args = parser.parse_args()

    region = args.region
    profile = args.profile

    os.environ['AWS_PROFILE'] = profile
    os.environ['AWS_REGION'] = region

    list_codebuild_projects(region, profile)

if __name__ == '__main__':
    main()
